{"ast":null,"code":"function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n\n  _setPrototypeOf(subClass, superClass);\n}\n\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n\n  return _setPrototypeOf(o, p);\n}\n\nimport Span from './span';\nimport SpanBase from './span-base';\nimport { generateRandomId, merge, now, getTime, extend, removeInvalidChars } from '../common/utils';\nimport { REUSABILITY_THRESHOLD, TRUNCATED_TYPE } from '../common/constants';\nimport { captureBreakdown as _captureBreakdown } from './breakdown';\n\nvar Transaction = function (_SpanBase) {\n  _inheritsLoose(Transaction, _SpanBase);\n\n  function Transaction(name, type, options) {\n    var _this;\n\n    _this = _SpanBase.call(this, name, type, options) || this;\n    _this.traceId = generateRandomId();\n    _this.marks = undefined;\n    _this.spans = [];\n    _this._activeSpans = {};\n    _this._activeTasks = new Set();\n    _this.blocked = false;\n    _this.captureTimings = false;\n    _this.breakdownTimings = [];\n    _this.sampleRate = _this.options.transactionSampleRate;\n    _this.sampled = Math.random() <= _this.sampleRate;\n    return _this;\n  }\n\n  var _proto = Transaction.prototype;\n\n  _proto.addMarks = function addMarks(obj) {\n    this.marks = merge(this.marks || {}, obj);\n  };\n\n  _proto.mark = function mark(key) {\n    var skey = removeInvalidChars(key);\n\n    var markTime = now() - this._start;\n\n    var custom = {};\n    custom[skey] = markTime;\n    this.addMarks({\n      custom: custom\n    });\n  };\n\n  _proto.canReuse = function canReuse() {\n    var threshold = this.options.reuseThreshold || REUSABILITY_THRESHOLD;\n    return !!this.options.canReuse && !this.ended && now() - this._start < threshold;\n  };\n\n  _proto.redefine = function redefine(name, type, options) {\n    if (name) {\n      this.name = name;\n    }\n\n    if (type) {\n      this.type = type;\n    }\n\n    if (options) {\n      extend(this.options, options);\n    }\n  };\n\n  _proto.startSpan = function startSpan(name, type, options) {\n    var _this2 = this;\n\n    if (this.ended) {\n      return;\n    }\n\n    var opts = extend({}, options);\n\n    opts.onEnd = function (trc) {\n      _this2._onSpanEnd(trc);\n    };\n\n    opts.traceId = this.traceId;\n    opts.sampled = this.sampled;\n    opts.sampleRate = this.sampleRate;\n\n    if (!opts.parentId) {\n      opts.parentId = this.id;\n    }\n\n    var span = new Span(name, type, opts);\n    this._activeSpans[span.id] = span;\n\n    if (opts.blocking) {\n      this.addTask(span.id);\n    }\n\n    return span;\n  };\n\n  _proto.isFinished = function isFinished() {\n    return !this.blocked && this._activeTasks.size === 0;\n  };\n\n  _proto.detectFinish = function detectFinish() {\n    if (this.isFinished()) this.end();\n  };\n\n  _proto.end = function end(endTime) {\n    if (this.ended) {\n      return;\n    }\n\n    this.ended = true;\n    this._end = getTime(endTime);\n\n    for (var sid in this._activeSpans) {\n      var span = this._activeSpans[sid];\n      span.type = span.type + TRUNCATED_TYPE;\n      span.end(endTime);\n    }\n\n    this.callOnEnd();\n  };\n\n  _proto.captureBreakdown = function captureBreakdown() {\n    this.breakdownTimings = _captureBreakdown(this);\n  };\n\n  _proto.block = function block(flag) {\n    this.blocked = flag;\n\n    if (!this.blocked) {\n      this.detectFinish();\n    }\n  };\n\n  _proto.addTask = function addTask(taskId) {\n    if (!taskId) {\n      taskId = 'task-' + generateRandomId(16);\n    }\n\n    this._activeTasks.add(taskId);\n\n    return taskId;\n  };\n\n  _proto.removeTask = function removeTask(taskId) {\n    var deleted = this._activeTasks.delete(taskId);\n\n    deleted && this.detectFinish();\n  };\n\n  _proto.resetFields = function resetFields() {\n    this.spans = [];\n    this.sampleRate = 0;\n  };\n\n  _proto._onSpanEnd = function _onSpanEnd(span) {\n    this.spans.push(span);\n    delete this._activeSpans[span.id];\n    this.removeTask(span.id);\n  };\n\n  _proto.isManaged = function isManaged() {\n    return !!this.options.managed;\n  };\n\n  return Transaction;\n}(SpanBase);\n\nexport default Transaction;","map":{"version":3,"sources":["/home/harish/windo/phoenix/node_modules/@elastic/apm-rum-core/dist/es/performance-monitoring/transaction.js"],"names":["_inheritsLoose","subClass","superClass","prototype","Object","create","constructor","_setPrototypeOf","o","p","setPrototypeOf","__proto__","Span","SpanBase","generateRandomId","merge","now","getTime","extend","removeInvalidChars","REUSABILITY_THRESHOLD","TRUNCATED_TYPE","captureBreakdown","_captureBreakdown","Transaction","_SpanBase","name","type","options","_this","call","traceId","marks","undefined","spans","_activeSpans","_activeTasks","Set","blocked","captureTimings","breakdownTimings","sampleRate","transactionSampleRate","sampled","Math","random","_proto","addMarks","obj","mark","key","skey","markTime","_start","custom","canReuse","threshold","reuseThreshold","ended","redefine","startSpan","_this2","opts","onEnd","trc","_onSpanEnd","parentId","id","span","blocking","addTask","isFinished","size","detectFinish","end","endTime","_end","sid","callOnEnd","block","flag","taskId","add","removeTask","deleted","delete","resetFields","push","isManaged","managed"],"mappings":"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","sourcesContent":["function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; _setPrototypeOf(subClass, superClass); }\n\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\nimport Span from './span';\nimport SpanBase from './span-base';\nimport { generateRandomId, merge, now, getTime, extend, removeInvalidChars } from '../common/utils';\nimport { REUSABILITY_THRESHOLD, TRUNCATED_TYPE } from '../common/constants';\nimport { captureBreakdown as _captureBreakdown } from './breakdown';\n\nvar Transaction = function (_SpanBase) {\n  _inheritsLoose(Transaction, _SpanBase);\n\n  function Transaction(name, type, options) {\n    var _this;\n\n    _this = _SpanBase.call(this, name, type, options) || this;\n    _this.traceId = generateRandomId();\n    _this.marks = undefined;\n    _this.spans = [];\n    _this._activeSpans = {};\n    _this._activeTasks = new Set();\n    _this.blocked = false;\n    _this.captureTimings = false;\n    _this.breakdownTimings = [];\n    _this.sampleRate = _this.options.transactionSampleRate;\n    _this.sampled = Math.random() <= _this.sampleRate;\n    return _this;\n  }\n\n  var _proto = Transaction.prototype;\n\n  _proto.addMarks = function addMarks(obj) {\n    this.marks = merge(this.marks || {}, obj);\n  };\n\n  _proto.mark = function mark(key) {\n    var skey = removeInvalidChars(key);\n\n    var markTime = now() - this._start;\n\n    var custom = {};\n    custom[skey] = markTime;\n    this.addMarks({\n      custom: custom\n    });\n  };\n\n  _proto.canReuse = function canReuse() {\n    var threshold = this.options.reuseThreshold || REUSABILITY_THRESHOLD;\n    return !!this.options.canReuse && !this.ended && now() - this._start < threshold;\n  };\n\n  _proto.redefine = function redefine(name, type, options) {\n    if (name) {\n      this.name = name;\n    }\n\n    if (type) {\n      this.type = type;\n    }\n\n    if (options) {\n      extend(this.options, options);\n    }\n  };\n\n  _proto.startSpan = function startSpan(name, type, options) {\n    var _this2 = this;\n\n    if (this.ended) {\n      return;\n    }\n\n    var opts = extend({}, options);\n\n    opts.onEnd = function (trc) {\n      _this2._onSpanEnd(trc);\n    };\n\n    opts.traceId = this.traceId;\n    opts.sampled = this.sampled;\n    opts.sampleRate = this.sampleRate;\n\n    if (!opts.parentId) {\n      opts.parentId = this.id;\n    }\n\n    var span = new Span(name, type, opts);\n    this._activeSpans[span.id] = span;\n\n    if (opts.blocking) {\n      this.addTask(span.id);\n    }\n\n    return span;\n  };\n\n  _proto.isFinished = function isFinished() {\n    return !this.blocked && this._activeTasks.size === 0;\n  };\n\n  _proto.detectFinish = function detectFinish() {\n    if (this.isFinished()) this.end();\n  };\n\n  _proto.end = function end(endTime) {\n    if (this.ended) {\n      return;\n    }\n\n    this.ended = true;\n    this._end = getTime(endTime);\n\n    for (var sid in this._activeSpans) {\n      var span = this._activeSpans[sid];\n      span.type = span.type + TRUNCATED_TYPE;\n      span.end(endTime);\n    }\n\n    this.callOnEnd();\n  };\n\n  _proto.captureBreakdown = function captureBreakdown() {\n    this.breakdownTimings = _captureBreakdown(this);\n  };\n\n  _proto.block = function block(flag) {\n    this.blocked = flag;\n\n    if (!this.blocked) {\n      this.detectFinish();\n    }\n  };\n\n  _proto.addTask = function addTask(taskId) {\n    if (!taskId) {\n      taskId = 'task-' + generateRandomId(16);\n    }\n\n    this._activeTasks.add(taskId);\n\n    return taskId;\n  };\n\n  _proto.removeTask = function removeTask(taskId) {\n    var deleted = this._activeTasks.delete(taskId);\n\n    deleted && this.detectFinish();\n  };\n\n  _proto.resetFields = function resetFields() {\n    this.spans = [];\n    this.sampleRate = 0;\n  };\n\n  _proto._onSpanEnd = function _onSpanEnd(span) {\n    this.spans.push(span);\n    delete this._activeSpans[span.id];\n    this.removeTask(span.id);\n  };\n\n  _proto.isManaged = function isManaged() {\n    return !!this.options.managed;\n  };\n\n  return Transaction;\n}(SpanBase);\n\nexport default Transaction;"]},"metadata":{},"sourceType":"module"}